<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Fitco Stripe Subscription Console</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        background: #f4f6f8;
        color: #1f2937;
      }
      .container {
        max-width: 1100px;
        margin: 24px auto;
        padding: 0 16px 32px;
      }
      h1 {
        margin: 0 0 6px;
      }
      .subtitle {
        margin: 0 0 18px;
        color: #4b5563;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 14px;
      }
      .card {
        background: #fff;
        border: 1px solid #dde3ea;
        border-radius: 10px;
        padding: 14px;
      }
      .card h3 {
        margin: 0 0 10px;
      }
      label {
        display: block;
        margin: 8px 0 4px;
        font-weight: 600;
      }
      input,
      select,
      button {
        width: 100%;
        box-sizing: border-box;
        padding: 9px;
        border: 1px solid #cfd8e3;
        border-radius: 8px;
      }
      .row {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
      }
      .row-3 {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 8px;
      }
      button {
        margin-top: 10px;
        background: #1f7a44;
        color: #fff;
        border: none;
        cursor: pointer;
        font-weight: 600;
      }
      button.secondary {
        background: #334155;
      }
      pre {
        margin-top: 14px;
        background: #111827;
        color: #e5e7eb;
        padding: 14px;
        border-radius: 10px;
        overflow: auto;
        min-height: 160px;
      }
      @media (max-width: 900px) {
        .grid,
        .row,
        .row-3 {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Fitco Stripe Subscription Console</h1>
      <p class="subtitle">User checkout flow + admin pricing/coupon/subscription tools</p>

      <div class="card">
        <h3>Base Config</h3>
        <label>API Base URL</label>
        <input id="baseUrl" value="http://localhost:5000" />
      </div>

      <div class="grid">
        <div class="card">
          <h3>User Subscription</h3>
          <label>User Access Token</label>
          <input id="userToken" placeholder="Bearer token from user login" />

          <div class="row">
            <div>
              <label>Plan Type</label>
              <select id="planType">
                <option value="monthly">monthly</option>
                <option value="yearly">yearly</option>
              </select>
            </div>
            <div>
              <label>Coupon Code</label>
              <input id="couponCode" placeholder="WELCOME10" />
            </div>
          </div>

          <p style="margin: 8px 0 0; color: #4b5563; font-size: 14px;">
            Success/cancel redirect URLs are now taken from backend `.env` only.
          </p>

          <button id="btnPlans">Get Plans</button>
          <button id="btnQuote">Get Quote</button>
          <button id="btnCheckout">Create Checkout Session</button>
        </div>

        <div class="card">
          <h3>Admin Pricing</h3>
          <label>Admin Access Token</label>
          <input id="adminToken" placeholder="Bearer token from admin login" />

          <div class="row-3">
            <div>
              <label>Monthly (cents)</label>
              <input id="monthlyPriceCents" value="999" />
            </div>
            <div>
              <label>Yearly (cents)</label>
              <input id="yearlyPriceCents" value="9999" />
            </div>
            <div>
              <label>Currency</label>
              <input id="currency" value="usd" />
            </div>
          </div>

          <button id="btnGetPricing">Get Subscription Pricing</button>
          <button id="btnUpdatePricing">Update Subscription Pricing</button>

          <label>Admin Subscriptions (page/limit)</label>
          <div class="row">
            <input id="subPage" value="1" />
            <input id="subLimit" value="20" />
          </div>
          <button class="secondary" id="btnListSubscriptions">List Subscriptions</button>

          <label>Subscription ID</label>
          <input id="subscriptionId" placeholder="Mongo subscription id" />
          <button class="secondary" id="btnSubDetails">Get Subscription Details</button>
        </div>
      </div>

      <div class="card" style="margin-top: 14px;">
        <h3>Admin Coupons</h3>
        <div class="row-3">
          <div>
            <label>Code</label>
            <input id="couponCreateCode" value="WELCOME10" />
          </div>
          <div>
            <label>Discount %</label>
            <input id="couponDiscount" value="10" />
          </div>
          <div>
            <label>Expiry ISO</label>
            <input id="couponExpiry" value="2027-12-31T23:59:59.000Z" />
          </div>
        </div>
        <button id="btnCreateCoupon">Create Coupon</button>
        <button class="secondary" id="btnListCoupons">List Coupons</button>

        <div class="row" style="margin-top: 10px;">
          <div>
            <label>Coupon ID</label>
            <input id="couponId" placeholder="Coupon id for update/toggle/delete" />
          </div>
          <div>
            <label>isActive (true/false)</label>
            <input id="couponIsActive" value="true" />
          </div>
        </div>

        <button id="btnUpdateCoupon">Update Coupon</button>
        <button id="btnToggleCoupon">Toggle Coupon Status</button>
        <button id="btnDeleteCoupon">Delete Coupon</button>
      </div>

      <pre id="output">No request yet.</pre>
    </div>

    <script>
      const output = document.getElementById('output');
      const getBaseUrl = () => document.getElementById('baseUrl').value.trim();
      const userToken = () => document.getElementById('userToken').value.trim();
      const adminToken = () => document.getElementById('adminToken').value.trim();

      const toJSON = async (res) => {
        const text = await res.text();
        try {
          return text ? JSON.parse(text) : {};
        } catch {
          return { raw: text };
        }
      };

      const req = async ({ method, path, token, body }) => {
        const headers = {};
        if (token) headers.Authorization = `Bearer ${token}`;
        if (body !== undefined) headers['Content-Type'] = 'application/json';

        const res = await fetch(`${getBaseUrl()}${path}`, {
          method,
          headers,
          body: body !== undefined ? JSON.stringify(body) : undefined
        });
        const json = await toJSON(res);
        const response = { ok: res.ok, status: res.status, path, method, bodySent: body || null, data: json };
        output.textContent = JSON.stringify(response, null, 2);
        return response;
      };

      document.getElementById('btnPlans').onclick = () =>
        req({ method: 'GET', path: '/api/v1/subscriptions/plans', token: userToken() });

      document.getElementById('btnQuote').onclick = () =>
        req({
          method: 'POST',
          path: '/api/v1/subscriptions/quote',
          token: userToken(),
          body: {
            planType: document.getElementById('planType').value,
            couponCode: document.getElementById('couponCode').value.trim() || undefined
          }
        });

      document.getElementById('btnCheckout').onclick = async () => {
        const res = await req({
          method: 'POST',
          path: '/api/v1/subscriptions/checkout-session',
          token: userToken(),
          body: {
            planType: document.getElementById('planType').value,
            couponCode: document.getElementById('couponCode').value.trim() || undefined
          }
        });
        if (res.ok && res.data.checkoutUrl) {
          window.location.href = res.data.checkoutUrl;
        }
      };

      document.getElementById('btnGetPricing').onclick = () =>
        req({ method: 'GET', path: '/api/v1/dashboard/subscription-pricing', token: adminToken() });

      document.getElementById('btnUpdatePricing').onclick = () =>
        req({
          method: 'PATCH',
          path: '/api/v1/dashboard/subscription-pricing',
          token: adminToken(),
          body: {
            monthlyPriceCents: Number(document.getElementById('monthlyPriceCents').value),
            yearlyPriceCents: Number(document.getElementById('yearlyPriceCents').value),
            currency: document.getElementById('currency').value.trim().toLowerCase()
          }
        });

      document.getElementById('btnListSubscriptions').onclick = () =>
        req({
          method: 'GET',
          path: `/api/v1/subscriptions?page=${encodeURIComponent(document.getElementById('subPage').value)}&limit=${encodeURIComponent(document.getElementById('subLimit').value)}`,
          token: adminToken()
        });

      document.getElementById('btnSubDetails').onclick = () =>
        req({
          method: 'GET',
          path: `/api/v1/subscriptions/${document.getElementById('subscriptionId').value.trim()}`,
          token: adminToken()
        });

      document.getElementById('btnCreateCoupon').onclick = () =>
        req({
          method: 'POST',
          path: '/api/v1/coupons',
          token: adminToken(),
          body: {
            code: document.getElementById('couponCreateCode').value.trim(),
            discountPercentage: Number(document.getElementById('couponDiscount').value),
            expiryDate: document.getElementById('couponExpiry').value.trim()
          }
        });

      document.getElementById('btnListCoupons').onclick = () =>
        req({ method: 'GET', path: '/api/v1/coupons', token: adminToken() });

      document.getElementById('btnUpdateCoupon').onclick = () =>
        req({
          method: 'PUT',
          path: `/api/v1/coupons/${document.getElementById('couponId').value.trim()}`,
          token: adminToken(),
          body: {
            discountPercentage: Number(document.getElementById('couponDiscount').value),
            expiryDate: document.getElementById('couponExpiry').value.trim()
          }
        });

      document.getElementById('btnToggleCoupon').onclick = () =>
        req({
          method: 'PATCH',
          path: `/api/v1/coupons/${document.getElementById('couponId').value.trim()}/status`,
          token: adminToken(),
          body: {
            isActive: String(document.getElementById('couponIsActive').value).toLowerCase() === 'true'
          }
        });

      document.getElementById('btnDeleteCoupon').onclick = () =>
        req({
          method: 'DELETE',
          path: `/api/v1/coupons/${document.getElementById('couponId').value.trim()}`,
          token: adminToken()
        });
    </script>
  </body>
</html>
